name: Deploy to AWS ECS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: mentors-nexus
  ECS_SERVICE: mentors-nexus-task-service-f1diicfw
  ECS_CLUSTER: mentors-nexus-cluster-a

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Run Unit Tests
        id: test
        run: |
          echo "ðŸ§ª Running unit tests..."
          ./gradlew test --info --stacktrace 2>&1 | tee test-output.log
        continue-on-error: true

      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Test Results
          path: 'build/test-results/test/*.xml'
          reporter: java-junit
          fail-on-error: true
          max-annotations: 50

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/tests/test/
            build/test-results/test/
            test-output.log
          retention-days: 30

      - name: Upload Test Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-logs
          path: |
            test-output.log
            build/reports/tests/test/
          retention-days: 30

      - name: Generate Detailed Test Summary
        if: always()
        run: |
          echo "### ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d build/test-results/test ]; then
            TOTAL_TESTS=0
            FAILED_TESTS=0
            SKIPPED_TESTS=0
          
            for file in build/test-results/test/*.xml; do
              if [ -f "$file" ]; then
                TESTS=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1)
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1)
                SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1)
          
                TOTAL_TESTS=$((TOTAL_TESTS + ${TESTS:-0}))
                FAILED_TESTS=$((FAILED_TESTS + ${FAILURES:-0}))
                SKIPPED_TESTS=$((SKIPPED_TESTS + ${SKIPPED:-0}))
              fi
            done
          
            PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))
          
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            if [ "$FAILED_TESTS" -eq 0 ]; then
              echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **$FAILED_TESTS test(s) failed**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Failed Tests Details:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
          
              # Extract detailed failure information
              for file in build/test-results/test/*.xml; do
                if [ -f "$file" ]; then
                  # Check if file has failures
                  if grep -q '<failure' "$file"; then
                    echo "##### $(basename $file .xml)" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
          
                    # Extract test case names and messages
                    while IFS= read -r line; do
                      TEST_NAME=$(echo "$line" | grep -oP 'name="\K[^"]+' || echo "Unknown")
                      CLASS_NAME=$(echo "$line" | grep -oP 'classname="\K[^"]+' || echo "Unknown")
                      echo "**Test:** \`$CLASS_NAME.$TEST_NAME\`" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
          
                      # Get failure message
                      FAILURE_MSG=$(sed -n "/<testcase.*name=\"$TEST_NAME\"/,/<\/testcase>/p" "$file" | grep -oP '<failure[^>]*message="\K[^"]+' | head -1)
                      if [ -n "$FAILURE_MSG" ]; then
                        echo "**Error:** $FAILURE_MSG" >> $GITHUB_STEP_SUMMARY
                        echo "" >> $GITHUB_STEP_SUMMARY
                      fi
          
                      # Get first few lines of stack trace
                      STACK_TRACE=$(sed -n "/<testcase.*name=\"$TEST_NAME\"/,/<\/testcase>/p" "$file" | sed -n '/<failure/,/<\/failure>/p' | sed 's/<[^>]*>//g' | head -10)
                      if [ -n "$STACK_TRACE" ]; then
                        echo "<details>" >> $GITHUB_STEP_SUMMARY
                        echo "<summary>Stack Trace (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
                        echo "" >> $GITHUB_STEP_SUMMARY
                        echo '```' >> $GITHUB_STEP_SUMMARY
                        echo "$STACK_TRACE" >> $GITHUB_STEP_SUMMARY
                        echo '```' >> $GITHUB_STEP_SUMMARY
                        echo "</details>" >> $GITHUB_STEP_SUMMARY
                        echo "" >> $GITHUB_STEP_SUMMARY
                      fi
                    done < <(grep '<testcase' "$file" | grep -A1 '<failure')
                  fi
                fi
              done
            fi
          
            # Add link to full report
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ [View Full Test Report in Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Test Status
        if: always()
        run: |
          if [ -d build/test-results/test ]; then
            FAILED_TESTS=0
          
            for file in build/test-results/test/*.xml; do
              if [ -f "$file" ]; then
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1)
                FAILED_TESTS=$((FAILED_TESTS + ${FAILURES:-0}))
              fi
            done
          
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "âŒ $FAILED_TESTS test(s) failed"
              exit 1
            else
              echo "âœ… All tests passed"
            fi
          else
            echo "âš ï¸ No test results found"
            exit 1
          fi

      - name: Comment Test Results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let testSummary = '## ðŸ§ª Test Results\n\n';
            
            try {
              const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
              testSummary += summary;
            } catch (error) {
              testSummary += 'âš ï¸ Unable to read test summary\n';
            }
            
            testSummary += '\n\n---\n';
            testSummary += '**Commit:** `' + context.sha.substring(0, 7) + '`\n';
            testSummary += '**Run:** [#' + context.runNumber + '](' + 
                           'https://github.com/' + context.repo.owner + '/' + 
                           context.repo.repo + '/actions/runs/' + context.runId + ')\n';
            testSummary += '*Updated at: ' + new Date().toUTCString() + '*';
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ§ª Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: testSummary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: testSummary
              });
            }

  # ... rest of your workflow jobs ...